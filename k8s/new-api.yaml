---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: new-api-master-data-pvc
  namespace: new-api
spec:
  accessModes:
    - ReadWriteOnce  # 本地集群只支持 RWO
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Secret
metadata:
  name: new-api-secret
  namespace: new-api
type: Opaque
stringData:
  SESSION_SECRET: "your-random-session-secret-change-this-123456"
  CRYPTO_SECRET: "your-random-crypto-secret-change-this-123456"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: new-api-config
  namespace: new-api
data:
  SQL_DSN: "root:123456@tcp(mysql:3306)/new-api"
  REDIS_CONN_STRING: "redis://redis:6379"
  TZ: "Asia/Shanghai"
  ERROR_LOG_ENABLED: "true"
---
# 主节点 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: new-api-master
  namespace: new-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: new-api
      role: master
  template:
    metadata:
      labels:
        app: new-api
        role: master
    spec:
      containers:
      - name: new-api
        image: calciumion/new-api:latest
        args: ["--log-dir", "/app/logs"]
        ports:
        - containerPort: 3000
        env:
        - name: SQL_DSN
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: SQL_DSN
        - name: REDIS_CONN_STRING
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: REDIS_CONN_STRING
        - name: TZ
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: TZ
        - name: ERROR_LOG_ENABLED
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: ERROR_LOG_ENABLED
        - name: SESSION_SECRET
          valueFrom:
            secretKeyRef:
              name: new-api-secret
              key: SESSION_SECRET
        - name: CRYPTO_SECRET
          valueFrom:
            secretKeyRef:
              name: new-api-secret
              key: CRYPTO_SECRET
        volumeMounts:
        - name: data
          mountPath: /data
        - name: logs
          mountPath: /app/logs
        livenessProbe:
          httpGet:
            path: /api/status
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/status
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        resources:
          requests:
            cpu: 1000m       # 1 核心
            memory: 1Gi      # 1GB
          limits:
            cpu: 3000m       # 3 核心，处理突发流量
            memory: 4Gi      # 4GB
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: new-api-master-data-pvc
      - name: logs
        emptyDir: {}  # 日志使用临时存储
---
# 从节点 Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: new-api-slave
  namespace: new-api
spec:
  replicas: 3  # 3个从节点，支持约 3000 QPS
  selector:
    matchLabels:
      app: new-api
      role: slave
  template:
    metadata:
      labels:
        app: new-api
        role: slave
    spec:
      containers:
      - name: new-api
        image: calciumion/new-api:latest
        args: ["--log-dir", "/app/logs"]
        ports:
        - containerPort: 3000
        env:
        - name: SQL_DSN
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: SQL_DSN
        - name: REDIS_CONN_STRING
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: REDIS_CONN_STRING
        - name: TZ
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: TZ
        - name: ERROR_LOG_ENABLED
          valueFrom:
            configMapKeyRef:
              name: new-api-config
              key: ERROR_LOG_ENABLED
        - name: SESSION_SECRET
          valueFrom:
            secretKeyRef:
              name: new-api-secret
              key: SESSION_SECRET
        - name: CRYPTO_SECRET
          valueFrom:
            secretKeyRef:
              name: new-api-secret
              key: CRYPTO_SECRET
        - name: NODE_TYPE
          value: "slave"
        - name: SYNC_FREQUENCY
          value: "60"
        volumeMounts:
        - name: data
          mountPath: /data
        - name: logs
          mountPath: /app/logs
        livenessProbe:
          httpGet:
            path: /api/status
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/status
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
        resources:
          requests:
            cpu: 1000m       # 1 核心，每个从节点处理约 1000 QPS
            memory: 1Gi      # 1GB
          limits:
            cpu: 2000m       # 2 核心，处理突发流量
            memory: 2Gi      # 2GB
      volumes:
      - name: data
        emptyDir: {}  # 从节点使用临时存储，数据从数据库和Redis读取
      - name: logs
        emptyDir: {}  # 日志使用临时存储
---
apiVersion: v1
kind: Service
metadata:
  name: new-api
  namespace: new-api
spec:
  selector:
    app: new-api  # 匹配所有主从节点
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: 30000  # 本地访问端口
  type: NodePort
